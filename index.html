<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="icon" href="logo2.png" type="image/png"/>
  <title>Taller de simulaci√≥n - Toxicolog√≠a-FCM, UNLP</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0c8c9c;
      --primary-dark: #04545d;
      --accent: #c96d00;
      --bg-light: #f9f8f5;
      --white: #ffffff;
      --error: #b71c1c;
    }

    html, body {
      margin: 0; padding: 0; min-height: 100vh;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #087882 0%, #0c8c9c 40%, #045c63 70%, #04545d 100%);
      background-attachment: fixed;
      display: flex; flex-direction: column; justify-content: center;
    }

    main {
      background: rgba(249, 248, 245, 0.98); border-radius: 24px;
      width: 95%; max-width: 520px; padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 20px auto;
      box-sizing: border-box;
    }

    #logo { display: block; width: 100%; height: auto; margin-bottom: 20px; border-radius: 14px; }
    h1 { text-align: center; color: var(--primary-dark); margin-bottom: 20px; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

    form { background: var(--white); padding: 20px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
    label { display: block; margin-top: 15px; font-weight: 700; color: var(--primary-dark); font-size: 13px; margin-bottom: 5px; }

    input {
      width: 100%; padding: 12px; margin-top: 6px;
      border-radius: 12px; border: 2px solid #e8e8e8;
      box-sizing: border-box; font-size: 15px; transition: all 0.3s ease;
      background-color: #fafafa;
    }
    input:focus { border-color: var(--primary); outline: none; background-color: #fff; }

    /* CONTENEDOR DE TURNOS CON SCROLL */
    #contenedorTurnos {
      display: grid; grid-template-columns: 1fr; gap: 8px;
      margin-top: 10px; max-height: 220px; overflow-y: auto;
      padding: 5px; border: 1px inset #eee; border-radius: 12px;
      background: #fdfdfd;
    }

    .turno-card {
      background: white; border: 2px solid #e8e8e8; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; font-weight: 600; color: #444;
    }
    .turno-card:hover { border-color: var(--primary); background: #f0fbfc; }
    .turno-card.selected { border-color: var(--primary); background: var(--primary); color: white; transform: scale(0.98); }
    .turno-card .cupos { font-size: 11px; opacity: 0.8; font-weight: 400; }

    button { width: 100%; padding: 15px; margin-top: 20px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.3s; }
    #btnSubmit { background-color: var(--primary); color: white; }
    #btnSubmit:disabled { background-color: #ccc; cursor: not-allowed; }

    /* OVERLAYS Y MODALES */
    .overlay {
      position: fixed; inset: 0; background: rgba(4, 84, 93, 0.98);
      backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center;
      z-index: 99999; padding: 20px;
    }
    .modal {
      background: white; padding: 35px; border-radius: 28px;
      max-width: 450px; width: 100%; text-align: center;
    }
    .modal-emoji { font-size: 60px; display: block; margin-bottom: 15px; }
    .modal-instrucciones { background: #f0f7f8; padding: 20px; border-radius: 18px; text-align: left; margin-bottom: 20px; border: 1px solid #d0e6e9; }
    .modal ol { margin: 0; padding-left: 20px; color: #333; font-size: 14px; line-height: 1.7; }
    .btn-modal-main { background-color: var(--primary); color: white; }
    .btn-modal-sec { background-color: transparent; color: var(--primary); border: 2px solid var(--primary); margin-top: 12px; }

    #verInscripcionModal {
      display: none; position: fixed; inset: 0;
      background: rgba(4, 84, 93, 0.99); backdrop-filter: blur(12px);
      justify-content: center; align-items: center; z-index: 100000; padding: 20px;
    }

    .contacto { margin-top: 25px; text-align: center; font-size: 13px; color: var(--primary-dark); border-top: 1px solid #eee; padding-top: 15px; opacity: 0.8; }

    @media (max-width: 480px) {
      body { background: var(--bg-light); justify-content: flex-start; }
      main { margin: 0; width: 100%; min-height: 100vh; border-radius: 0; padding: 20px; }
    }
  </style>
</head>

<body>

  <div class="overlay" id="overlay">
    <div class="modal" id="modalContenido">
      <div>Verificando disponibilidad...</div>
    </div>
  </div>

  <main>
    <img src="logo.png" alt="Logo C√°tedra Toxicolog√≠a" id="logo">
    <h1>Talleres de Simulaci√≥n</h1>
    
    <form id="inscripcionForm">
      <label>Nombre Completo:</label>
      <input id="nombre" name="nombre" placeholder="Apellido y Nombre" required type="text"/>
      
      <label>Legajo:</label>
      <input id="legajo" name="legajo" placeholder="12345/6" required type="text"/>
      
      <label>Correo electr√≥nico:</label>
      <input id="email" name="email" placeholder="correo electr√≥nico" required type="email"/>
      
      <label>Seleccione una fecha disponible: <span id="ocupacionTotal" style="font-weight: 400; color: var(--accent);"></span></label>
      <div id="contenedorTurnos">
        <p style="font-size: 12px; color: #999; padding: 10px;">Cargando turnos...</p>
      </div>
      <input type="hidden" name="turno" id="turnoInput" required>
      <input type="hidden" id="turnoTextoSeleccionado">
      
      <button type="submit" id="btnSubmit">Confirmar Inscripci√≥n</button>
    </form>

    <div class="contacto">
        ¬© C√°tedra de Toxicolog√≠a, HoSiC<br/>
        Facultad de Ciencias M√©dicas - UNLP
    </div>
  </main>

  <div id="verInscripcionModal">
    <div class="modal">
      <span class="modal-emoji">üîç</span>
      <h2 style="color: var(--primary-dark);">CONSULTAR TURNO</h2>
      <input type="text" id="buscarLegajo" placeholder="Ej: 12345/6" style="margin-bottom: 10px; border-color: var(--primary); text-align: center;"/>
      <button class="btn-modal-main" onclick="buscarInscripcion()">Buscar Registro</button>
      <div id="resultadoBusqueda"></div>
      <button class="btn-modal-sec" style="color: #666; border-color: #ccc;" onclick="cerrarVerInscripcion()">Volver</button>
    </div>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbw0efPHaFlA2WSfvS2otcQpyT7QtG0M6n9erz_6v3Bag-z8yEV6tjk1ZkcU3qxUkM7GFQ/exec';
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=0&single=true&output=csv";

function parsearFechaZero(str) {
  const parts = str.trim().split('/');
  return new Date(20 + parts[2], parts[1] - 1, parts[0], 0, 0, 0);
}

// Carga inicial y control de acceso
fetch(csvURL).then(res => res.text()).then(csv => {
  const filas = csv.trim().split("\n").map(f => f.split(","));
  const [inicioStr, finStr] = filas[1][5].split('-');
  const fInicio = parsearFechaZero(inicioStr), fFin = parsearFechaZero(finStr), hoy = new Date();
  const modal = document.getElementById('modalContenido');

  if (hoy < fInicio) {
    modal.innerHTML = `<span class="modal-emoji">‚è≥</span><h2>PR√ìXIMAMENTE</h2><div class="modal-instrucciones" style="text-align:center;">Apertura de inscripciones:<br><strong>${inicioStr} - 00:00 hs</strong></div>`;
  } else if (hoy >= fFin) {
    modal.innerHTML = `<span class="modal-emoji">üèÅ</span><h2>ETAPA FINALIZADA</h2><div class="modal-instrucciones" style="text-align:center;">El per√≠odo concluy√≥ el ${finStr}.</div><button class="btn-modal-main" onclick="abrirVerInscripcion()">Consultar mi turno</button>`;
  } else {
    modal.innerHTML = `<span class="modal-emoji">üìã</span><h2>AVISO IMPORTANTE</h2><div class="modal-instrucciones"><ol><li>Seleccione una <strong>fecha por √∫nica vez</strong>. No hay cambios.</li><li>Verifique su <strong>disponibilidad horaria</strong>.</li><li>Escriba su nombre: <strong>APELLIDO Y NOMBRE</strong>.</li></ol></div><button class="btn-modal-main" onclick="cerrarModal()">Aceptar e inscribirme</button><button class="btn-modal-sec" onclick="abrirVerInscripcion()">Ya estoy inscripto / Ver mi turno</button>`;
    actualizarTurnos();
  }
});

function cerrarModal() { document.getElementById('overlay').style.display = 'none'; }
function abrirVerInscripcion() { document.getElementById('overlay').style.display = 'none'; document.getElementById('verInscripcionModal').style.display = 'flex'; }
function cerrarVerInscripcion() { location.reload(); }

function actualizarTurnos() {
  fetch(scriptURL + '?action=turnos').then(res => res.json()).then(data => {
    const contenedor = document.getElementById('contenedorTurnos');
    contenedor.innerHTML = '';
    let libresTotal = 0;
    data.forEach(t => { 
      if(t.disponible) {
        libresTotal += Number(t.cupos);
        const card = document.createElement('div');
        card.className = 'turno-card';
        card.innerHTML = `<span>${t.texto.replace(/hs\b/i, " h")}</span><span class="cupos">${t.cupos} libres</span>`;
        card.onclick = () => {
          document.querySelectorAll('.turno-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          document.getElementById('turnoInput').value = t.id;
          document.getElementById('turnoTextoSeleccionado').value = t.texto.split(' (Cupos:')[0];
        };
        contenedor.appendChild(card);
      }
    });
    document.getElementById('ocupacionTotal').textContent = `(${Math.round(((140-libresTotal)/140)*100)}% lleno)`;
  });
}

// Env√≠o con doble validaci√≥n (Confirmaci√≥n y Cupo en tiempo real)
document.getElementById('inscripcionForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const idTurno = document.getElementById('turnoInput').value;
  const textoTurno = document.getElementById('turnoTextoSeleccionado').value;

  if(!idTurno) { alert("Por favor, seleccion√° una fecha de la lista."); return; }

  // 1. Mensaje de confirmaci√≥n amigable
  const confirmacion = confirm(`Est√°s por inscribirte al turno:\n\nüìÖ ${textoTurno}\n\n¬øEs correcto?`);
  
  if (!confirmacion) return;

  const b = document.getElementById('btnSubmit');
  b.disabled = true; b.textContent = 'Verificando cupo...';

  // 2. Verificaci√≥n final antes de inscribir para que no se pisen
  try {
    const checkRes = await fetch(scriptURL + '?action=turnos');
    const dataTurnos = await checkRes.json();
    const turnoActualizado = dataTurnos.find(t => t.id == idTurno);

    if (!turnoActualizado || !turnoActualizado.disponible) {
      alert("¬°Lo sentimos! Alguien acaba de reservar el √∫ltimo lugar en este turno. Por favor, eleg√≠ otro disponible.");
      actualizarTurnos();
      b.disabled = false; b.textContent = 'Confirmar Inscripci√≥n';
      return;
    }

    // Si hay cupo, procedemos al registro
    b.textContent = 'Procesando...';
    const response = await fetch(scriptURL, { method: 'POST', body: new FormData(e.target) });
    const resultado = await response.text();
    
    if(resultado.toLowerCase().includes("duplicado")) {
      alert("Ya figura una inscripci√≥n con este Legajo.");
    } else {
      alert("¬°Inscripci√≥n Exitosa!");
    }
    location.reload();

  } catch (error) {
    alert("Hubo un error de conexi√≥n. Intent√° nuevamente.");
    b.disabled = false; b.textContent = 'Confirmar Inscripci√≥n';
  }
});

function buscarInscripcion() {
  const leg = document.getElementById('buscarLegajo').value.trim();
  const resDiv = document.getElementById('resultadoBusqueda');
  if(!leg) return;
  resDiv.innerHTML = '<p>Buscando...</p>';
  fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=1122482966&single=true&output=csv')
    .then(res => res.text()).then(csv => {
      const filas = csv.trim().split('\n').slice(1);
      const f = filas.find(r => r.split(',')[1].trim() === leg);
      if(f){
        const c = f.split(',');
        resDiv.innerHTML = `<div style="background:#f0f7f8; padding:15px; border-radius:12px; margin-top:15px; text-align:left; border-left:5px solid var(--primary);"><p style="font-weight:700; margin:0;">${c[0].replace(/"/g, '')}</p><p style="margin:5px 0; font-size:13px; color:var(--accent); font-weight:700;">üìÖ ${c[4].split(' (Cupos:')[0]}</p></div>`;
      } else { resDiv.innerHTML = '<p style="color:var(--error); margin-top:10px; font-weight:700;">‚ùå Legajo no encontrado.</p>'; }
    });
}

document.getElementById('legajo').addEventListener('input', (e) => {
  let v = e.target.value.replace(/[^0-9]/g, '');
  if (v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5, 6);
  e.target.value = v;
});
</script>
</body>
</html>










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































