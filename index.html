<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="logo2.png" type="image/png"/>
  <title>Taller de simulación - Toxicología-FCM, UNLP</title>

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* VARIABLES DE COLOR INSTITUCIONAL */
    :root {
      --primary: #0c8c9c;
      --primary-dark: #04545d;
      --accent: #e07b00;
      --bg-light: #f9f8f5;
      --white: #ffffff;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #087882 0%, #0c8c9c 40%, #045c63 70%, #04545d 100%);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    /* CONTENEDOR PRINCIPAL */
    main {
      background: rgba(249, 248, 245, 0.98);
      border-radius: 20px;
      width: 95%;
      max-width: 520px;
      padding: 35px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      margin: 40px auto;
      transition: all 0.3s ease;
    }

    /* LOGO: Respetado tamaño original */
    #logo {
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin-bottom: 25px;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* FORMULARIO */
    form {
      background: var(--white);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: 1px solid #eee;
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 14px;
      text-transform: uppercase;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 2px solid #e1e1e1;
      box-sizing: border-box;
      font-size: 15px;
      transition: all 0.2s ease;
      background-color: #fdfdfd;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 4px rgba(12, 140, 156, 0.1);
      background-color: var(--white);
    }

    /* BOTONES */
    button {
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #inscripcionForm button[type="submit"] {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(12, 140, 156, 0.3);
    }

    #inscripcionForm button[type="submit"]:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(4, 84, 93, 0.4);
    }

    #guardarBtn {
      display: none;
      background-color: #2e7d32; /* Verde más sobrio e institucional */
      color: white;
      width: auto;
      padding: 12px 25px;
      margin: 20px auto 0;
    }

    #guardarBtn:hover {
      background-color: #1b5e20;
    }

    /* AVISOS Y LOADER */
    #aviso-descarga {
      display: none;
      margin-top: 20px;
      font-size: 14px;
      text-align: center;
      color: #d84315;
      font-weight: 600;
      padding: 10px;
      background: #fff3e0;
      border-radius: 8px;
    }

    #loader {
      display: none;
      text-align: center;
      margin-top: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    /* POPUPS Y MODALES */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(4, 84, 93, 0.85);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .modal {
      background: white;
      padding: 35px;
      border-radius: 20px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }

    .modal h2 {
      text-align: center;
      color: var(--accent);
      margin-top: 0;
    }

    .modal ol {
      padding-left: 20px;
      line-height: 1.6;
      color: #444;
    }

    .modal button {
      background-color: var(--accent);
      color: white;
      margin-top: 10px;
    }

    .modal button#verInscripBtn {
      background-color: #666;
      font-size: 14px;
    }

    #popup, #popup-error, #verInscripcionModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 30px;
      border-radius: 16px;
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background-color: var(--white);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    #popup { border-top: 6px solid var(--primary); }
    #popup-error { border: 2px solid #c62828; background-color: #ffebee; color: #b71c1c; }

    /* FOOTER Y CONTACTO */
    .contacto {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: var(--primary-dark);
      line-height: 1.5;
    }

    footer {
      text-align: center;
      padding: 20px 0;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-top: auto;
    }

    @media (max-width: 480px) {
      main { padding: 25px 20px; margin: 0; width: 100%; border-radius: 0; }
    }
  </style>
</head>

<body>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>⚠ ATENCIÓN</h2>
      <ol>
        <li>Solo podrá inscribirse y seleccionar una <strong>fecha por única vez</strong>.</li>
        <li>Antes de inscribirse, verifique su <strong>disponibilidad horaria</strong>.</li>
        <li style="color:#c62828; font-weight: 700;">Respete el orden Apellido y Nombre/s.</li>
      </ol>
      <button onclick="cerrarModal()">Aceptar, quiero inscribirme</button>
      <button id="verInscripBtn" onclick="abrirVerInscripcion(); cerrarModal()">Ya estoy inscripto</button>
    </div>
  </div>

  <main>
    <img src="logo.png" alt="Logo Cátedra Toxicología" id="logo">

    <h1>TALLERES DE SIMULACIÓN</h1>

    <div id="mensajeF2" style="display:none; text-align:center; margin:0 0 15px 0; color:#b22222; font-weight:700; background:#fbe9e7; padding:10px; border-radius:8px;"></div>

    <form id="inscripcionForm">
      <label for="nombre">Alumno:</label>
      <input id="nombre" name="nombre" placeholder="Apellido y Nombre" required type="text"/>
      
      <label for="legajo">Legajo:</label>
      <input id="legajo" name="legajo" placeholder="12345/6" required type="text"/>
      
      <label for="email">Correo electrónico:</label>
      <input id="email" name="email" placeholder="alumno@gmail.com" required type="email"/>
      
      <label for="turno">
        Seleccione: 
        <span id="ocupacionTotal" style="float:right; font-size: 0.9em;"></span>
      </label>
      <select id="turno" name="turno" required>
        <option disabled selected value="">Cargando fechas...</option>
      </select>
      
      <div id="avisoCierre" style="display:none; color:red; font-weight:bold; margin-top:15px; text-align:center;"></div>
      
      <button type="submit">Confirmar Inscripción</button>
    </form>

    <div id="loader">Inscribiendo Alumno<span id="dots"></span></div>
    
    <div id="aviso-descarga">✅ ¡Inscripción exitosa!<br>Descargue su comprobante ahora.</div>
    <button id="guardarBtn">Descargar Comprobante</button>
    
    <canvas id="descargaCanvas" style="display:none;"></canvas>
    
    <div id="popup">Inscripción exitosa. Te esperamos en el Hospital de simulación en tu fecha seleccionada.</div>
    <div id="popup-error">Usted ya posee una fecha reservada, no es posible realizar una nueva.</div>

    <div id="verInscripcionModal"></div>

    <div class="contacto">
      © Cátedra de Toxicología, HoSiC, FCM - UNLP<br/>
      <strong style="font-weight: 700; color: var(--primary);">toxicoalumnos@gmail.com</strong>
    </div>
  </main>

  <footer>
    Facultad de Ciencias Médicas - Universidad Nacional de La Plata
  </footer>

  <script>
    // --- TODA TU LÓGICA ORIGINAL SE MANTIENE INTACTA ABAJO ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw0efPHaFlA2WSfvS2otcQpyT7QtG0M6n9erz_6v3Bag-z8yEV6tjk1ZkcU3qxUkM7GFQ/exec';
    const TOTAL_CUPOS = 140; 
    let dotsInterval;

    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=0&single=true&output=csv";

    fetch(urlCSV)
      .then(res => res.text())
      .then(csv => {
        const filas = csv.trim().split("\n").map(f => f.split(","));
        const mensaje = filas[1] && filas[1][5] ? filas[1][5].trim() : "";
        if (mensaje) {
          const div = document.getElementById("mensajeF2");
          div.textContent = mensaje;
          div.style.display = "block";
        }
      })
      .catch(err => console.error("Error al leer F2:", err));

    function actualizarTurnos() {
      fetch(scriptURL + '?action=turnos')
        .then(res => res.json())
        .then(data => {
          const turnoSelect = document.getElementById('turno');
          const avisoCierre = document.getElementById('avisoCierre');

          if (data.estado === "cerrado") {
            turnoSelect.style.display = "none";
            avisoCierre.style.display = "block";
            avisoCierre.textContent = data.mensaje || "Las inscripciones están cerradas.";
            return;
          } else {
            turnoSelect.style.display = "block";
            avisoCierre.style.display = "none";
          }

          turnoSelect.innerHTML = '<option value="" disabled selected>Fechas disponibles...</option>';
          let sumCuposDisponibles = 0;
          data.forEach(turno => {
            if (turno.disponible) {
              sumCuposDisponibles += Number(turno.cupos);
              const option = document.createElement('option');
              option.value = turno.id;
              option.textContent = `${turno.texto.replace(/hs\b/i, " h")} (Cupos: ${turno.cupos})`;
              turnoSelect.appendChild(option);
            }
          });

          const ocupados = TOTAL_CUPOS - sumCuposDisponibles;
          const porcentaje = Math.round((ocupados / TOTAL_CUPOS) * 100);
          const ocupacionSpan = document.getElementById('ocupacionTotal');
          ocupacionSpan.textContent = `${porcentaje}% de ocupación`;
          ocupacionSpan.style.color = porcentaje <= 50 ? 'green' : (porcentaje <= 80 ? 'orange' : 'red');
        });
    }

    function cerrarModal() {
      document.getElementById('overlay').style.display = 'none';
      actualizarTurnos();
    }

    document.getElementById('inscripcionForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const loader = document.getElementById('loader');
      const dotsEl = document.getElementById('dots');
      loader.style.display = 'block';
      let count = 0;
      dotsInterval = setInterval(() => {
        count = (count + 1) % 4;
        dotsEl.textContent = '.'.repeat(count);
      }, 400);

      const form = document.getElementById('inscripcionForm');
      const formData = new FormData(form);
      fetch(scriptURL, { method: 'POST', body: formData })
      .then(response => response.text())
      .then(respuesta => {
        clearInterval(dotsInterval);
        loader.style.display = 'none';
        if (respuesta.toLowerCase().includes('duplicado')) {
          document.getElementById('popup-error').style.display = 'block';
          setTimeout(() => document.getElementById('popup-error').style.display = 'none', 5000);
        } else {
          generarImagenConfirmacion();
          document.getElementById('aviso-descarga').style.display = 'block';
          document.getElementById('popup').style.display = 'block';
          actualizarTurnos();
          setTimeout(() => document.getElementById('popup').style.display = 'none', 6000);
        }
      });
    });

    document.getElementById('guardarBtn').addEventListener('click', function () {
      const canvas = document.getElementById('descargaCanvas');
      const enlace = document.createElement('a');
      enlace.download = 'confirmacion_turno.png';
      enlace.href = canvas.toDataURL('image/png');
      enlace.click();
      setTimeout(() => location.reload(), 1000);
    });

    function generarImagenConfirmacion() {
      const nombre = document.getElementById('nombre').value;
      const legajo = document.getElementById('legajo').value;
      const turno = document.getElementById('turno').selectedOptions[0].textContent;
      const canvas = document.getElementById('descargaCanvas');
      const ctx = canvas.getContext('2d');
      const width = 600; const height = 300;
      const scale = 2;
      canvas.width = width * scale; canvas.height = height * scale;
      ctx.scale(scale, scale);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      const logo = new Image();
      logo.src = 'logo.png';
      logo.onload = () => {
        ctx.drawImage(logo, 225, 20, 150, 75);
        ctx.fillStyle = '#38828f'; ctx.font = 'bold 22px Arial'; ctx.textAlign = 'center';
        ctx.fillText('Confirmación de Inscripción', width / 2, 130);
        ctx.fillStyle = '#333'; ctx.font = '16px Arial'; ctx.textAlign = 'left';
        ctx.fillText(`Alumno: ${nombre}`, 50, 180);
        ctx.fillText(`Legajo: ${legajo}`, 50, 210);
        ctx.fillText(`Turno: ${turno}`, 50, 240);
        document.getElementById('guardarBtn').style.display = 'block';
      };
    }

    document.getElementById('legajo').addEventListener('input', function (e) {
      let valor = e.target.value.replace(/[^0-9]/g, '');
      if (valor.length > 5) valor = valor.slice(0, 5) + '/' + valor.slice(5, 6);
      e.target.value = valor;
    });

    function abrirVerInscripcion() {
      const modalBusqueda = document.getElementById('verInscripcionModal');
      modalBusqueda.style.display = 'block';
      modalBusqueda.innerHTML = `
        <h2>MI INSCRIPCIÓN</h2>
        <label>Legajo:</label>
        <input type="text" id="buscarLegajo" placeholder="12345/6"/>
        <button onclick="buscarInscripcion()" style="background:var(--primary); color:white;">Buscar</button>
        <div id="resultadoBusqueda" style="margin-top:15px; font-size:15px;"></div>
        <button style="margin-top:15px; background:#666; color:white;" onclick="cerrarVerInscripcion()">Cerrar</button>
      `;
    }

    function cerrarVerInscripcion() { document.getElementById('verInscripcionModal').style.display = 'none'; }

    function buscarInscripcion() {
      const legajoInput = document.getElementById('buscarLegajo');
      let legajo = legajoInput.value;
      const urlInscripciones = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=1122482966&single=true&output=csv';
      fetch(urlInscripciones)
        .then(res => res.text())
        .then(csvText => {
          const filas = csvText.trim().split('\n').slice(1);
          let encontrado = false;
          filas.forEach(fila => {
            const columnas = fila.split(',');
            if (columnas[1].trim() === legajo) {
              document.getElementById('resultadoBusqueda').innerHTML = `<div style="background:#f0f7f8; padding:10px; border-radius:8px;"><strong>${columnas[0]}</strong><br>Turno: ${columnas[4]}</div>`;
              encontrado = true;
            }
          });
          if (!encontrado) document.getElementById('resultadoBusqueda').textContent = 'No se encontró inscripción.';
        });
    }
  </script>
</body>
</html>


















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































