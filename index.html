<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="logo2.png" type="image/png"/>
  <title>Taller de simulación - Toxicología-FCM, UNLP</title>

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0c8c9c;
      --primary-dark: #04545d;
      --accent: #c96d00; /* Ocre institucional satisfactorio */
      --bg-light: #f9f8f5;
      --white: #ffffff;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #087882 0%, #0c8c9c 40%, #045c63 70%, #04545d 100%);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    main {
      background: rgba(249, 248, 245, 0.98);
      border-radius: 20px;
      width: 95%;
      max-width: 520px;
      padding: 35px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      margin: 40px auto;
    }

    #logo {
      display: block;
      width: 100%;
      height: auto;
      margin-bottom: 25px;
      border-radius: 12px;
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin-bottom: 25px;
      font-size: 22px;
      font-weight: 700;
    }

    form {
      background: var(--white);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: 1px solid #eee;
    }

    label {
      display: block;
      margin-top: 18px;
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 2px solid #e1e1e1;
      box-sizing: border-box;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 4px rgba(12, 140, 156, 0.1);
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 20px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #inscripcionForm button[type="submit"] {
      background-color: var(--primary);
      color: white;
    }

    #guardarBtn {
      display: none;
      background-color: #2e7d32;
      color: white;
      width: auto;
      padding: 12px 25px;
      margin: 20px auto 0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(4, 84, 93, 0.85);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .modal {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 92%;
    }

    .modal h2 { text-align: center; color: var(--accent); margin-top: 0; }

    .modal ol {
      padding-left: 20px;
      line-height: 1.6;
      color: #444;
      font-size: 0.92em;
    }

    .modal button { background-color: var(--accent); color: white; }
    #verInscripBtn { background-color: #666 !important; margin-top: 10px; }

    .contacto {
      margin-top: 25px;
      text-align: center;
      font-size: 14px;
      color: #04545d;
    }

    footer {
      text-align: center;
      padding: 10px 0;
      font-size: 13px;
      color: #c6d5da;
    }

    @media (max-width: 480px) {
      main { padding: 25px 20px; margin: 0; width: 100%; border-radius: 0; }
    }
  </style>
</head>

<body>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>⚠ ATENCIÓN</h2>
      <ol>
        <li>Solo podrá inscribirse y seleccionar una <strong>fecha por única vez</strong>.</li>
        <li>Antes de inscribirse, verifique su <strong>disponibilidad horaria</strong>.</li>
        <li style="color:#b71c1c; font-weight: 700;">Respete el orden Apellido y Nombre/s.</li>
      </ol>
      <button onclick="cerrarModal()">Aceptar, quiero inscribirme</button>
      <button id="verInscripBtn" onclick="abrirVerInscripcion(); cerrarModal()">Ya estoy inscripto</button>
    </div>
  </div>

  <main>
    <img src="logo.png" alt="Logo Cátedra Toxicología" id="logo">
    <h1>TALLERES DE SIMULACIÓN</h1>
    <div id="mensajeF2" style="display:none; text-align:center; margin-bottom:15px; color:#b22222; font-weight:600;"></div>

    <form id="inscripcionForm">
      <label for="nombre">Alumno:</label>
      <input id="nombre" name="nombre" placeholder="Apellido y Nombre" required type="text"/>
      <label for="legajo">Legajo:</label>
      <input id="legajo" name="legajo" placeholder="12345/6" required type="text"/>
      <label for="email">Correo electrónico:</label>
      <input id="email" name="email" placeholder="alumno@gmail.com" required type="email"/>
      <label for="turno">Seleccione: <span id="ocupacionTotal" style="font-weight:bold;"></span></label>
      <select id="turno" name="turno" required>
        <option disabled selected value="">Cargando fechas...</option>
      </select>
      <div id="avisoCierre" style="display:none; color:red; font-weight:bold; margin-top:10px; text-align:center;"></div>
      <button type="submit">Inscribirme</button>
    </form>

    <div id="loader" style="display:none; text-align:center; margin-top:15px; font-weight:bold; color:var(--primary-dark);">Inscribiendo<span id="dots"></span></div>
    
    <div id="aviso-descarga" style="display:none; text-align:center; margin-top:15px; color:#d84315; font-size:14px; font-weight:600;">Descargue el comprobante de inscripción. Por favor, agende la fecha seleccionada.</div>
    <button id="guardarBtn">Descargar Comprobante</button>
    <canvas id="descargaCanvas" style="display:none;"></canvas>

    <div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:14px; border:2px solid var(--primary); z-index:10000; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3);">Inscripción exitosa. Te esperamos en el Hospital de simulación.</div>
    <div id="popup-error" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#ffebee; color:#b71c1c; padding:30px; border-radius:14px; border:2px solid #c62828; z-index:10000; text-align:center;">Usted ya posee una fecha reservada.</div>

    <div id="verInscripcionModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:14px; border:2px solid var(--primary); z-index:10000; width:90%; max-width:400px;"></div>

    <div class="contacto">
        © Cátedra de Toxicología, HoSiC, Facultad de Ciencias Médicas - UNLP<br/>
        <strong style="font-weight: 700;">toxicoalumnos@gmail.com</strong>
    </div>
  </main>

  <footer>
    Facultad de Ciencias Médicas - Universidad Nacional de La Plata
  </footer>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbw0efPHaFlA2WSfvS2otcQpyT7QtG0M6n9erz_6v3Bag-z8yEV6tjk1ZkcU3qxUkM7GFQ/exec';
const TOTAL_CUPOS = 140; 
let dotsInterval;

fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=0&single=true&output=csv")
  .then(res => res.text())
  .then(csv => {
    const filas = csv.trim().split("\n").map(f => f.split(","));
    const mensaje = filas[1] && filas[1][5] ? filas[1][5].trim() : "";
    if (mensaje) {
      const div = document.getElementById("mensajeF2");
      div.textContent = mensaje; div.style.display = "block";
    }
  });

function actualizarTurnos() {
  fetch(scriptURL + '?action=turnos')
    .then(res => res.json())
    .then(data => {
      const turnoSelect = document.getElementById('turno');
      const avisoCierre = document.getElementById('avisoCierre');
      if (data.estado === "cerrado") {
        turnoSelect.style.display = "none";
        avisoCierre.style.display = "block";
        avisoCierre.textContent = data.mensaje || "Inscripciones cerradas.";
        return;
      }
      turnoSelect.innerHTML = '<option value="" disabled selected>Fechas disponibles...</option>';
      let sumCupos = 0;
      data.forEach(t => {
        if (t.disponible) {
          sumCupos += Number(t.cupos);
          const opt = document.createElement('option');
          opt.value = t.id; opt.textContent = `${t.texto.replace(/hs\b/i, " h")} (Cupos: ${t.cupos})`;
          turnoSelect.appendChild(opt);
        }
      });
      const perc = Math.round(((TOTAL_CUPOS - sumCupos) / TOTAL_CUPOS) * 100);
      const span = document.getElementById('ocupacionTotal');
      span.textContent = `${perc}% de ocupación`;
      span.style.color = perc <= 50 ? 'green' : (perc <= 80 ? 'orange' : 'red');
    });
}

function cerrarModal() { document.getElementById('overlay').style.display = 'none'; actualizarTurnos(); }

document.getElementById('inscripcionForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const loader = document.getElementById('loader');
  const dotsEl = document.getElementById('dots');
  loader.style.display = 'block';
  let count = 0;
  dotsInterval = setInterval(() => { count = (count + 1) % 4; dotsEl.textContent = '.'.repeat(count); }, 400);

  fetch(scriptURL, { method: 'POST', body: new FormData(e.target) })
  .then(res => res.text())
  .then(respuesta => {
    clearInterval(dotsInterval);
    loader.style.display = 'none';
    if (respuesta.toLowerCase().includes('duplicado')) {
      document.getElementById('popup-error').style.display = 'block';
      setTimeout(() => document.getElementById('popup-error').style.display = 'none', 5000);
    } else {
      generarImagenConfirmacion();
      document.getElementById('aviso-descarga').style.display = 'block';
      document.getElementById('popup').style.display = 'block';
      actualizarTurnos();
      setTimeout(() => document.getElementById('popup').style.display = 'none', 6000);
    }
  });
});

document.getElementById('guardarBtn').addEventListener('click', function () {
  const canvas = document.getElementById('descargaCanvas');
  const enlace = document.createElement('a');
  enlace.download = 'comprobante_inscripcion.png';
  enlace.href = canvas.toDataURL('image/png', 1.0);
  enlace.click();
  setTimeout(() => location.reload(), 1000);
});

function generarImagenConfirmacion() {
  const nombre = document.getElementById('nombre').value;
  const legajo = document.getElementById('legajo').value;
  const turnoOriginal = document.getElementById('turno').selectedOptions[0].textContent;
  const turnoLimpio = turnoOriginal.split(' (Cupos:')[0]; 
  
  const canvas = document.getElementById('descargaCanvas');
  const ctx = canvas.getContext('2d');
  
  const w = 400; const h = 600;
  const dpi = 2; 
  canvas.width = w * dpi; canvas.height = h * dpi;
  ctx.scale(dpi, dpi);

  // Fondo blanco base
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, w, h);

  // --- MARCA DE AGUA ---
  ctx.save();
  ctx.fillStyle = 'rgba(12, 140, 156, 0.06)'; // Color suave
  ctx.font = 'bold 12px "Open Sans", Arial';
  ctx.rotate(-45 * Math.PI / 180); // Rotación diagonal
  for (let x = -w; x < w * 2; x += 180) {
    for (let y = -h; y < h * 2; y += 40) {
      ctx.fillText('Cátedra de Toxicología', x, y);
    }
  }
  ctx.restore();

  const logo = new Image();
  logo.src = 'logo.png';
  logo.onload = () => {
    const logow = 280; const logoh = (logo.height * logow) / logo.width;
    ctx.drawImage(logo, (w - logow) / 2, 40, logow, logoh);

    ctx.fillStyle = '#0c8c9c';
    ctx.font = 'bold 22px "Open Sans", Arial';
    ctx.textAlign = 'center';
    ctx.fillText('COMPROBANTE', w / 2, logoh + 80);
    ctx.fillText('DE INSCRIPCIÓN', w / 2, logoh + 110);

    ctx.strokeStyle = 'rgba(238, 238, 238, 0.8)'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(40, logoh + 140); ctx.lineTo(w - 40, logoh + 140); ctx.stroke();

    ctx.textAlign = 'left'; ctx.fillStyle = '#333333';
    ctx.font = 'bold 14px "Open Sans", Arial';
    ctx.fillText('ALUMNO:', 50, logoh + 180);
    ctx.font = '16px "Open Sans", Arial';
    ctx.fillText(nombre.toUpperCase(), 50, logoh + 205);

    ctx.font = 'bold 14px "Open Sans", Arial';
    ctx.fillText('LEGAJO:', 50, logoh + 250);
    ctx.font = '16px "Open Sans", Arial';
    ctx.fillText(legajo, 50, logoh + 275);

    ctx.font = 'bold 14px "Open Sans", Arial';
    ctx.fillText('FECHA Y TURNO:', 50, logoh + 320);
    ctx.font = '16px "Open Sans", Arial';
    
    const words = turnoLimpio.split(' ');
    ctx.fillText(words.slice(0,3).join(' '), 50, logoh + 345);
    ctx.fillText(words.slice(3).join(' '), 50, logoh + 370);

    ctx.fillStyle = 'rgba(245, 245, 245, 0.9)';
    ctx.fillRect(0, h - 80, w, 80);
    ctx.fillStyle = '#666666'; ctx.font = '12px Arial'; ctx.textAlign = 'center';
    ctx.fillText('Presentar este comprobante el día del taller.', w / 2, h - 45);
    ctx.fillText('Cátedra de Toxicología - FCM - UNLP', w / 2, h - 25);

    document.getElementById('guardarBtn').style.display = 'block';
  };
}

document.getElementById('legajo').addEventListener('input', function (e) {
  let v = e.target.value.replace(/[^0-9]/g, '');
  if (v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5, 6);
  e.target.value = v;
});

function abrirVerInscripcion() {
  const m = document.getElementById('verInscripcionModal');
  m.style.display = 'block';
  m.innerHTML = `<h2>MI INSCRIPCIÓN</h2><label>Legajo:</label><input type="text" id="buscarLegajo" placeholder="12345/6"/><button onclick="buscarInscripcion()" style="background:var(--primary); color:white;">Buscar</button><div id="resultadoBusqueda" style="margin-top:15px;"></div><button style="margin-top:10px; background:#666; color:white;" onclick="cerrarVerInscripcion()">Cerrar</button>`;
}
function cerrarVerInscripcion() { document.getElementById('verInscripcionModal').style.display = 'none'; }
function buscarInscripcion() {
  const leg = document.getElementById('buscarLegajo').value;
  fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=1122482966&single=true&output=csv')
    .then(res => res.text()).then(csv => {
      const filas = csv.trim().split('\n').slice(1);
      const f = filas.find(r => r.split(',')[1].trim() === leg);
      if(f){
        const cols = f.split(',');
        const tLimpio = cols[4].split(' (Cupos:')[0];
        document.getElementById('resultadoBusqueda').innerHTML = `<p><strong>${cols[0]}</strong><br>Turno: ${tLimpio}</p>`;
      } else {
        document.getElementById('resultadoBusqueda').textContent = 'No encontrado.';
      }
    });
}
</script>
</body>
</html>

















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































