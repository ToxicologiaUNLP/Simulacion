<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <link rel="icon" href="logo2.png" type="image/png"/>
  <title>Taller de simulación - Toxicología-FCM, UNLP</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary: #0c8c9c;
      --primary-dark: #04545d;
      --accent: #c96d00;
      --bg-light: #f9f8f5;
      --white: #ffffff;
      --text-dark: #333333;
    }

    html, body {
      margin: 0; padding: 0; min-height: 100vh;
      font-family: 'Open Sans', sans-serif;
      background: #e9ecef;
      display: flex; flex-direction: column; justify-content: center;
    }

    main {
      background: var(--white); border-radius: 12px;
      width: 95%; max-width: 500px; padding: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 20px auto;
      box-sizing: border-box;
    }

    #logo { display: block; width: 100%; max-width: 250px; margin: 0 auto 20px; }
    h1 { text-align: center; color: var(--primary-dark); margin-bottom: 25px; font-size: 18px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }

    form { background: transparent; }
    label { display: block; margin-top: 15px; font-weight: 700; color: var(--primary-dark); font-size: 13px; }

    input {
      width: 100%; padding: 12px; margin-top: 6px;
      border-radius: 8px; border: 1px solid #ced4da;
      box-sizing: border-box; font-size: 15px;
    }

    #contenedorTurnos {
      display: grid; grid-template-columns: 1fr; gap: 8px;
      margin-top: 10px; max-height: 200px; overflow-y: auto;
      padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;
    }

    .turno-card {
      background: white; border: 1px solid #dee2e6; padding: 12px;
      border-radius: 8px; cursor: pointer; transition: 0.2s;
      display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600;
    }
    .turno-card.selected { border-color: var(--primary); background: var(--primary); color: white; }

    button { width: 100%; padding: 15px; margin-top: 20px; border-radius: 8px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; }
    #btnSubmit { background-color: var(--primary); color: white; }

    /* MODALES GENERALES */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 99999; padding: 20px; }
    .modal { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
    .modal h2 { color: var(--primary-dark); font-size: 18px; margin-top: 0; }
    .btn-modal-main { background-color: var(--primary); color: white; margin-top: 15px; }
    .btn-modal-sec { background-color: #6c757d; color: white; margin-top: 10px; }

    /* COMPROBANTE FORMAL 16:9 */
    #comprobanteModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100000; padding: 10px; overflow-y: auto; flex-direction: column; align-items: center; }
    .ticket-container { width: 320px; height: 568px; background: white; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; position: relative; border: 1px solid #ccc; }
    .ticket-header { background: #f8f9fa; color: var(--primary-dark); padding: 20px; text-align: center; border-bottom: 2px solid var(--primary); }
    .logo-ticket { width: 100px; margin-bottom: 10px; }
    .ticket-body { padding: 30px 25px; flex-grow: 1; display: flex; flex-direction: column; }
    .info-group { margin-bottom: 20px; }
    .info-label { font-size: 10px; color: #666; text-transform: uppercase; font-weight: 700; }
    .info-value { font-size: 15px; font-weight: 600; color: var(--text-dark); display: block; margin-top: 3px; }
    .qr-area { margin-top: auto; display: flex; justify-content: center; padding: 20px; border-top: 1px solid #eee; }

    #verInscripcionModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100000; }
  </style>
</head>

<body>

  <div class="overlay" id="overlay">
    <div class="modal" id="modalContenido">Cargando datos...</div>
  </div>

  <div class="overlay" id="confirmarModal" style="display:none;">
    <div class="modal">
      <h2>Confirmar Datos</h2>
      <div id="resumenInscripcion" style="text-align:left; font-size:14px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee;"></div>
      <button class="btn-modal-main" onclick="enviarFormulario()">Confirmar e Inscribirme</button>
      <button class="btn-modal-sec" onclick="cerrarConfirmar()">Corregir datos</button>
    </div>
  </div>

  <main id="mainContent">
    <img src="logo.png" alt="Logo Cátedra" id="logo">
    <h1>Taller de Simulación</h1>
    
    <form id="inscripcionForm">
      <label>Nombre Completo:</label>
      <input id="nombre" name="nombre" placeholder="APELLIDO Y NOMBRE" required type="text"/>
      
      <label>Legajo:</label>
      <input id="legajo" name="legajo" placeholder="12345/6" required type="text"/>
      
      <label>Correo electrónico:</label>
      <input id="email" name="email" placeholder="ejemplo@correo.com" required type="email"/>
      
      <label>Seleccione una fecha: <span id="ocupacionTotal" style="font-weight:400; color:var(--accent);"></span></label>
      <div id="contenedorTurnos"></div>
      
      <input type="hidden" name="turno" id="turnoInput" required>
      <input type="hidden" id="turnoTextoSeleccionado">
      
      <button type="button" onclick="abrirConfirmar()" id="btnPreSubmit">Inscribirme ahora</button>
    </form>
  </main>

  <div id="verInscripcionModal">
    <div class="modal">
      <h2>Consultar mi Turno</h2>
      <input type="text" id="buscarLegajo" placeholder="12345/6" style="text-align:center; margin-bottom:15px;">
      <button class="btn-modal-main" onclick="buscarInscripcion()">Buscar</button>
      <div id="resultadoBusqueda" style="margin-top:15px; font-size:14px;"></div>
      <button class="btn-modal-sec" onclick="cerrarVerInscripcion()">Cerrar</button>
    </div>
  </div>

  <div id="comprobanteModal">
    <div class="ticket-container" id="ticketImage">
      <div class="ticket-header">
        <img src="logo.png" class="logo-ticket">
        <div style="font-size:10px; font-weight:700; letter-spacing:1px;">COMPROBANTE DE INSCRIPCIÓN</div>
      </div>
      <div class="ticket-body">
        <div class="info-group"><span class="info-label">Alumno/a</span><span class="info-value" id="comp-nombre"></span></div>
        <div class="info-group"><span class="info-label">Legajo</span><span class="info-value" id="comp-legajo"></span></div>
        <div class="info-group"><span class="info-label">Fecha y Hora</span><span class="info-value" id="comp-turno" style="color:var(--primary-dark);"></span></div>
        <div class="info-group"><span class="info-label">Lugar</span><span class="info-value">HoSiC - Facultad de Cs. Médicas</span></div>
        <div class="qr-area"><div id="qrcode"></div></div>
      </div>
    </div>
    <button style="background:#28a745; color:white; max-width:320px;" onclick="descargarTicket()">⬇️ Guardar Comprobante</button>
    <button style="background:transparent; border:1px solid white; color:white; max-width:320px; margin-top:10px;" onclick="location.reload()">Finalizar</button>
  </div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbw0efPHaFlA2WSfvS2otcQpyT7QtG0M6erz_6v3Bag-z8yEV6tjk1ZkcU3qxUkM7GFQ/exec';
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=0&single=true&output=csv";

fetch(csvURL).then(res => res.text()).then(csv => {
  const filas = csv.trim().split("\n").map(f => f.split(","));
  const [inicioStr, finStr] = filas[1][5].split('-');
  const fInicio = new Date(20 + inicioStr.split('/')[2], inicioStr.split('/')[1]-1, inicioStr.split('/')[0]);
  const fFin = new Date(20 + finStr.split('/')[2], finStr.split('/')[1]-1, finStr.split('/')[0]);
  const hoy = new Date();
  
  const modal = document.getElementById('modalContenido');
  if (hoy < fInicio) {
    modal.innerHTML = `<h2>PRÓXIMAMENTE</h2><p>Inscripciones abiertas el ${inicioStr}</p>`;
  } else if (hoy >= fFin) {
    modal.innerHTML = `<h2>INSCRIPCIONES CERRADAS</h2><button class="btn-modal-main" onclick="abrirVerInscripcion()">Consultar mi turno</button>`;
  } else {
    modal.innerHTML = `<h2>AVISO</h2><div style="text-align:left; font-size:14px; margin-bottom:15px;">1. Elija su turno con cuidado.<br>2. Verifique su disponibilidad horaria.<br>3. Ingrese Nombre y Apellido completos.</div><button class="btn-modal-main" onclick="cerrarModal()">Entendido</button><button class="btn-modal-sec" onclick="abrirVerInscripcion()">Ya estoy inscripto</button>`;
    actualizarTurnos();
  }
});

function cerrarModal() { document.getElementById('overlay').style.display = 'none'; }
function abrirVerInscripcion() { document.getElementById('overlay').style.display = 'none'; document.getElementById('verInscripcionModal').style.display = 'flex'; }
function cerrarVerInscripcion() { document.getElementById('verInscripcionModal').style.display = 'none'; document.getElementById('overlay').style.display = 'flex'; }

function actualizarTurnos() {
  fetch(scriptURL + '?action=turnos').then(res => res.json()).then(data => {
    const contenedor = document.getElementById('contenedorTurnos');
    contenedor.innerHTML = '';
    let tMax = 0, tLib = 0;
    data.forEach(t => { 
      tMax += parseInt(t.cupoMax) || 0;
      tLib += parseInt(t.cupos) || 0;
      if(t.disponible) {
        const card = document.createElement('div');
        card.className = 'turno-card';
        card.innerHTML = `<span>${t.texto.split(' (')[0]}</span><span>${t.cupos} libres</span>`;
        card.onclick = () => {
          document.querySelectorAll('.turno-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          document.getElementById('turnoInput').value = t.id;
          document.getElementById('turnoTextoSeleccionado').value = t.texto.split(' (')[0];
        };
        contenedor.appendChild(card);
      }
    });
    // CORRECCIÓN INFINITY/NaN
    const porc = (tMax > 0) ? Math.max(0, Math.round(((tMax - tLib) / tMax) * 100)) : 0;
    document.getElementById('ocupacionTotal').textContent = `(${porc}% lleno)`;
  });
}

function abrirConfirmar() {
  const nombre = document.getElementById('nombre').value;
  const legajo = document.getElementById('legajo').value;
  const turno = document.getElementById('turnoTextoSeleccionado').value;
  if(!nombre || !legajo || !turno) return alert("Complete todos los campos y elija un turno.");
  
  document.getElementById('resumenInscripcion').innerHTML = `<b>Nombre:</b> ${nombre.toUpperCase()}<br><b>Legajo:</b> ${legajo}<br><b>Turno:</b> ${turno}`;
  document.getElementById('confirmarModal').style.display = 'flex';
}

function cerrarConfirmar() { document.getElementById('confirmarModal').style.display = 'none'; }

async function enviarFormulario() {
  cerrarConfirmar();
  const b = document.getElementById('btnPreSubmit');
  b.disabled = true; b.textContent = 'Procesando...';

  try {
    const response = await fetch(scriptURL, { method: 'POST', body: new FormData(document.getElementById('inscripcionForm')) });
    const resText = await response.text();
    if(resText.toLowerCase().includes("duplicado")) {
      alert("Error: El legajo ya está registrado.");
      location.reload();
    } else {
      document.getElementById('comp-nombre').textContent = document.getElementById('nombre').value.toUpperCase();
      document.getElementById('comp-legajo').textContent = document.getElementById('legajo').value;
      document.getElementById('comp-turno').textContent = document.getElementById('turnoTextoSeleccionado').value;
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), { text: "LEG:"+document.getElementById('legajo').value, width: 80, height: 80 });
      document.getElementById('comprobanteModal').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }
  } catch (e) { alert("Error de red."); b.disabled = false; b.textContent = 'Inscribirme ahora'; }
}

function descargarTicket() {
  html2canvas(document.getElementById('ticketImage'), { scale: 3 }).then(canvas => {
    const link = document.createElement('a');
    link.download = `Comprobante_${document.getElementById('legajo').value}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

function buscarInscripcion() {
  const leg = document.getElementById('buscarLegajo').value.trim();
  if(!leg) return;
  document.getElementById('resultadoBusqueda').innerHTML = 'Buscando...';
  fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQl056VY6Tv-hIeNjQrcElL4zusVkjizmfO8YJLqe6IhGwk4eYY3D1SeqpUFIP9RnESYuNGsc_sn7J3/pub?gid=1122482966&single=true&output=csv')
    .then(res => res.text()).then(csv => {
      const filas = csv.trim().split('\n').slice(1);
      const f = filas.find(r => r.split(',')[1].trim() === leg);
      if(f) {
        const c = f.split(',');
        document.getElementById('resultadoBusqueda').innerHTML = `<div style="background:#e9ecef; padding:10px; border-radius:5px;"><b>${c[0]}</b><br>${c[4]}</div>`;
      } else { document.getElementById('resultadoBusqueda').innerHTML = 'Legajo no encontrado.'; }
    });
}

document.getElementById('legajo').addEventListener('input', (e) => {
  let v = e.target.value.replace(/[^0-9]/g, '');
  if (v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5, 6);
  e.target.value = v;
});
</script>
</body>
</html>

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































